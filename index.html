<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阿米娅の窝 - PRTS Terminal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* 字体配置 */
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        :root {
            --amiya-accent: #38bdf8;
            --amiya-dark: #1e293b;
            --deep-thought-color: #6366f1;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f0f2f5;
            color: #262626;
        }

        .font-mono { font-family: 'JetBrains+Mono', monospace; }

        /* 滚动条 */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #94a3b8; }

        /* 形状样式 */
        .clip-rhombus { clip-path: polygon(20% 0%, 100% 0, 100% 80%, 80% 100%, 0 100%, 0% 20%); }
        .clip-msg-amiya { clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px)); }
        .clip-msg-doctor { clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%); }
        .clip-btn { clip-path: polygon(15% 0, 100% 0, 100% 85%, 85% 100%, 0 100%, 0 15%); }
        .clip-tag { clip-path: polygon(10% 0, 100% 0, 100% 100%, 0 100%, 0 25%); }
        .clip-modal { clip-path: polygon(0 0, 100% 0, 100% calc(100% - 20px), calc(100% - 20px) 100%, 0 100%); }
        
        /* 动画 */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); filter: blur(0px); } to { opacity: 0; transform: scale(1.05); filter: blur(10px); pointer-events: none;} }
        .animate-fade-out { animation: fadeOut 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        
        .input-glow:focus-within {
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.15);
            border-color: rgba(56, 189, 248, 0.5);
        }

        /* 深度思考模式特效 */
        @keyframes deep-breath {
            0%, 100% { box-shadow: 0 0 5px rgba(99, 102, 241, 0.3); border-color: rgba(99, 102, 241, 0.5); }
            50% { box-shadow: 0 0 15px rgba(99, 102, 241, 0.6); border-color: rgba(99, 102, 241, 0.9); }
        }
        .deep-thought-active {
            animation: deep-breath 2s infinite;
            background-color: rgba(99, 102, 241, 0.05);
        }
        
        /* 思维链样式 */
        .thinking-process {
            font-size: 0.85em; color: #64748b; background-color: #f8fafc; border-left: 2px solid #6366f1;
            padding: 8px 12px; margin-bottom: 12px; border-radius: 0 4px 4px 0; display: none;
        }
        .thinking-process.open { display: block; animation: fadeIn 0.3s ease; }
        .thinking-toggle {
            cursor: pointer; font-size: 0.75em; color: #6366f1; display: inline-flex; align-items: center; gap: 4px; margin-bottom: 4px; opacity: 0.8; transition: opacity 0.2s;
        }
        .thinking-toggle:hover { opacity: 1; }

        /* 待办事项样式 */
        .todo-item { transition: all 0.3s ease; }
        .todo-item.completed .todo-text { text-decoration: line-through; color: #9ca3af; }
        .todo-item.completed .todo-time { background-color: #f3f4f6; color: #9ca3af; }
        .todo-checkbox:checked { background-color: #38bdf8; border-color: #38bdf8; }
        
        /* 建议回复样式 (竖向+毛玻璃) */
        .suggestion-container {
            transition: max-height 0.4s ease-in-out, opacity 0.3s ease;
            max-height: 500px;
            overflow: hidden;
            opacity: 1;
        }
        .suggestion-container.collapsed {
            max-height: 0;
            opacity: 0;
            margin-bottom: 0 !important;
        }
        
        .suggestion-btn {
            display: block; width: 100%; text-align: left;
            background: rgba(255, 255, 255, 0.65); 
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.8);
            padding: 10px 14px; font-size: 13px; color: #4b5563;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin-bottom: 6px;
            border-radius: 2px;
        }
        .suggestion-btn:hover {
            background: rgba(255, 255, 255, 0.9);
            border-left-color: #38bdf8;
            transform: translateX(4px);
            color: #0f172a;
            box-shadow: 0 4px 10px rgba(56, 189, 248, 0.15);
        }
        .suggestion-toggle-icon { transition: transform 0.3s ease; }
        .suggestion-toggle-icon.rotate { transform: rotate(180deg); }
        
        /* 红点 */
        .badge-dot { position: absolute; top: -2px; right: -2px; width: 8px; height: 8px; background-color: #ef4444; border-radius: 50%; border: 1px solid white; }
    </style>
</head>
<body class="min-h-screen overflow-hidden relative">

    <!-- 生日弹窗 -->
    <div id="birthday-modal" class="fixed inset-0 z-[100] bg-white/30 backdrop-blur-xl flex flex-col items-center justify-center p-4 transition-all duration-700">
        <div class="relative bg-white shadow-2xl p-8 max-w-sm w-full text-center clip-modal border border-neutral-100">
            <div class="mb-6 flex justify-center">
                <div class="w-14 h-14 bg-neutral-900 text-white flex items-center justify-center clip-rhombus shadow-lg">
                    <span class="font-mono text-lg font-bold">12.23</span>
                </div>
            </div>
            <div class="h-1 w-8 bg-sky-400 mx-auto mb-6 rounded-full"></div>
            <h2 class="text-lg text-neutral-800 mb-2 font-bold tracking-wide">今天是阿米娅的生日</h2>
            <p class="text-neutral-500 mb-8 text-xs">让我们祝阿米娅生日快乐</p>
            <button onclick="enterTerminal()" class="group relative inline-flex items-center justify-center px-6 py-3 font-bold text-white transition-all duration-300 bg-sky-400 hover:bg-sky-500 shadow-lg hover:shadow-sky-300/40 clip-btn tracking-wider text-xs w-full">
                <span class="relative z-10">阿米娅生日快乐！</span>
                <div class="absolute inset-0 h-full w-full scale-0 transition-all duration-300 group-hover:scale-100 group-hover:bg-sky-500/50"></div>
            </button>
        </div>
    </div>

    <!-- 背景装饰 -->
    <div class="absolute inset-0 pointer-events-none opacity-[0.03]" style="background-image: radial-gradient(#000 1px, transparent 1px); background-size: 30px 30px;"></div>
    <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-sky-200/20 blur-[100px] rounded-full pointer-events-none"></div>
    <div class="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] bg-indigo-200/20 blur-[100px] rounded-full pointer-events-none"></div>

    <!-- 主容器 -->
    <div class="relative z-10 flex flex-col h-screen max-w-6xl mx-auto p-2 sm:p-4 lg:p-6 transition-all duration-500">
        
        <!-- Header -->
        <header class="flex justify-between items-end mb-4 px-2 select-none relative">
            <div class="flex items-center gap-4">
                <div class="w-14 h-14 bg-neutral-900 text-white flex flex-col items-center justify-center gap-0.5 shadow-xl clip-rhombus relative group overflow-hidden ring-1 ring-sky-500/30">
                    <div class="absolute inset-0 bg-sky-900/20 translate-y-full group-hover:translate-y-0 transition-transform duration-500"></div>
                    <span class="relative z-10 text-sm font-bold font-mono leading-none tracking-[0.2em] pl-0.5">PR</span>
                    <span class="relative z-10 text-sm font-bold font-mono leading-none tracking-[0.2em] pl-0.5">TS</span>
                </div>
                <div class="flex flex-col justify-end h-14 pb-1">
                    <h1 class="text-2xl font-bold tracking-widest text-neutral-800 leading-none flex items-center gap-2">阿米娅の窝</h1>
                    <div class="flex items-center gap-2 text-[10px] text-neutral-400 tracking-wider mt-1">聊天内容仅供参考，不会记录于PRTS</div>
                </div>
            </div>
            
            <div class="flex items-center gap-3 pb-1">
                <!-- 信赖度按钮 -->
                <button onclick="toggleTrustModal()" class="flex items-center gap-2 px-3 py-2 bg-white/80 hover:bg-rose-50 hover:text-rose-500 text-neutral-600 border border-neutral-200 transition-all duration-300 clip-btn shadow-sm group">
                    <i data-lucide="heart" width="16" height="16" class="text-rose-400 group-hover:fill-current transition-colors"></i>
                    <span class="text-xs font-bold font-mono hidden sm:inline">信赖值</span>
                </button>

                <!-- 待办事项按钮 -->
                <div class="relative">
                    <button onclick="toggleTodoModal()" class="flex items-center gap-2 px-4 py-2 bg-white/80 hover:bg-neutral-900 hover:text-white text-neutral-600 border border-neutral-200 transition-all duration-300 clip-btn shadow-sm">
                        <i data-lucide="clipboard-list" width="16" height="16"></i>
                        <span class="text-xs font-bold hidden sm:inline">待办</span>
                    </button>
                    <div id="todo-badge" class="hidden"><span class="badge-dot"></span></div>
                </div>

                <button onclick="toggleSettings()" class="p-2 bg-white/80 hover:bg-neutral-900 hover:text-white text-neutral-600 border border-neutral-200 transition-all duration-300 clip-btn shadow-sm">
                    <i data-lucide="settings" width="18" height="18"></i>
                </button>
            </div>
            <div class="absolute bottom-[-10px] left-2 right-2 h-[1px] bg-gradient-to-r from-transparent via-neutral-300 to-transparent"></div>
        </header>

        <!-- 聊天主区域 -->
        <main class="flex-1 flex flex-col bg-white/60 backdrop-blur-xl border border-white/60 shadow-2xl overflow-hidden relative mt-2 rounded-t-sm">
            <div class="h-1 w-full bg-gradient-to-r from-neutral-200 via-sky-500/30 to-neutral-200 opacity-50"></div>
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-8 scroll-smooth pb-20"></div>
            
            <div id="loading-indicator" class="hidden px-6 pb-4 ml-16 animate-fade-in">
                <div class="inline-flex items-center gap-3 bg-white/80 border border-sky-100 px-4 py-2 rounded-r-lg rounded-tl-lg shadow-sm">
                    <div class="flex gap-1">
                        <span class="w-1.5 h-1.5 bg-sky-400 rounded-full animate-bounce"></span>
                        <span class="w-1.5 h-1.5 bg-sky-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
                        <span class="w-1.5 h-1.5 bg-sky-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
                    </div>
                    <span class="text-xs font-mono text-sky-600/80">阿米娅思考中...</span>
                </div>
            </div>

            <!-- 输入区域 -->
            <div class="p-4 bg-white/80 backdrop-blur-md border-t border-white shadow-[0_-4px_20px_rgba(0,0,0,0.02)] relative z-20">
                <div class="max-w-4xl mx-auto relative">
                    
                    <!-- 建议回复区域：支持折叠 -->
                    <div id="suggestion-wrapper" class="mb-3 pl-12 sm:pl-0">
                        <div class="flex justify-between items-end mb-2 cursor-pointer" onclick="toggleSuggestionPanel()">
                            <span class="text-[10px] font-mono text-neutral-400 tracking-wider flex items-center gap-1 select-none">
                                <i data-lucide="sparkles" width="10"></i> PRTS SUGGESTIONS
                            </span>
                            <i id="suggestion-toggle-icon" data-lucide="chevron-down" width="14" class="text-neutral-400 suggestion-toggle-icon"></i>
                        </div>
                        
                        <div id="suggestion-list" class="suggestion-container flex flex-col gap-1">
                            <!-- 建议气泡将通过 JS 插入 -->
                        </div>
                    </div>

                    <div class="flex items-end gap-3">
                        <div class="w-10 h-10 bg-neutral-800 shrink-0 clip-rhombus flex items-center justify-center text-neutral-500 shadow-md border border-neutral-600 hidden sm:flex">
                            <span class="font-mono text-[10px] text-white">DR</span>
                        </div>

                        <div id="input-wrapper" class="flex-1 relative input-glow transition-all duration-300 bg-white border border-neutral-300 group">
                            <div class="absolute -top-[1px] -left-[1px] w-2 h-2 border-t-2 border-l-2 border-neutral-400 group-focus-within:border-sky-500 transition-colors"></div>
                            <div class="absolute -bottom-[1px] -right-[1px] w-2 h-2 border-b-2 border-r-2 border-neutral-400 group-focus-within:border-sky-500 transition-colors"></div>
                            
                            <textarea
                                id="user-input"
                                placeholder="请下达指令，博士..."
                                rows="1"
                                class="w-full bg-transparent text-neutral-800 placeholder-neutral-400 px-4 py-3 focus:outline-none resize-none text-sm min-h-[48px] max-h-[120px]"
                            ></textarea>
                        </div>

                        <div class="flex flex-col gap-1">
                             <button onclick="clearHistory()" class="p-2 text-neutral-400 hover:text-rose-500 transition-colors" title="清空记录">
                                <i data-lucide="trash-2" width="16"></i>
                            </button>
                            <button id="send-btn" onclick="sendMessage()" class="w-12 h-12 bg-neutral-900 text-white hover:bg-sky-600 shadow-lg hover:shadow-sky-500/30 transition-all duration-300 clip-btn flex items-center justify-center">
                                <i data-lucide="send" width="18"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 底部工具栏：认真思考按钮 -->
                    <div class="flex justify-between items-center mt-2 pl-12 sm:pl-0">
                        <button 
                            id="deep-thought-btn"
                            onclick="toggleDeepThought()"
                            class="flex items-center gap-2 px-3 py-1 text-xs font-bold text-neutral-400 bg-neutral-100 hover:bg-neutral-200 transition-all duration-300 rounded-sm border border-neutral-200/50 clip-tag"
                        >
                            <i data-lucide="brain-circuit" width="12"></i>
                            <span>认真思考</span>
                        </button>
                        
                        <div id="task-analyzing" class="hidden text-[10px] text-neutral-400 flex items-center gap-1 font-mono animate-pulse">
                            <i data-lucide="scan-search" width="10"></i> 记录中...
                        </div>
                    </div>

                </div>
                <div class="text-center mt-2 opacity-40">
                    <p class="text-[9px] font-mono tracking-[0.3em]">RHODES ISLAND PHARMACEUTICAL INC.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- 待办事项弹窗 -->
    <div id="todo-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-neutral-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-md p-0 shadow-2xl relative overflow-hidden clip-corner-sm">
            <div class="bg-neutral-900 text-white px-6 py-4 flex justify-between items-center relative overflow-hidden">
                <div class="absolute right-0 top-0 w-32 h-32 bg-yellow-500/20 rotate-45 translate-x-16 -translate-y-16"></div>
                <h2 class="text-sm font-bold font-mono flex items-center gap-2 tracking-wider z-10">
                    <i data-lucide="list-todo" width="16"></i> 待办事项清单
                </h2>
                <button onclick="toggleTodoModal()" class="text-neutral-400 hover:text-white z-10">
                    <i data-lucide="x" width="20"></i>
                </button>
            </div>
            <div class="p-4 bg-neutral-50 h-[300px] overflow-y-auto scrollbar-thin">
                <div id="todo-list" class="space-y-2"></div>
            </div>
            <div class="bg-white border-t border-neutral-200 p-3 flex justify-between items-center text-xs text-neutral-500">
                <span id="todo-count">0 项未完成</span>
                <span class="font-mono text-[10px] opacity-60">PRTS SYNC</span>
            </div>
        </div>
    </div>

    <!-- 信赖度弹窗 -->
    <div id="trust-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-neutral-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-sm p-0 shadow-2xl relative overflow-hidden clip-corner-sm border-t-4 border-rose-400">
            <div class="p-8 text-center relative">
                <button onclick="toggleTrustModal()" class="absolute top-4 right-4 text-neutral-400 hover:text-black">
                    <i data-lucide="x" width="20"></i>
                </button>
                
                <div class="mb-4 relative inline-block">
                    <div class="w-16 h-16 bg-neutral-100 rounded-full mx-auto flex items-center justify-center text-rose-500 shadow-inner">
                        <i data-lucide="heart" width="32" height="32" fill="currentColor"></i>
                    </div>
                    <div class="absolute -inset-1 border border-rose-200 rounded-full animate-pulse"></div>
                </div>
                
                <h3 class="text-xl font-bold text-neutral-800 mb-1">阿米娅的信赖值</h3>
                <p class="text-xs text-neutral-400 mb-6 font-mono">TRUST OVERVIEW</p>
                
                <div class="text-3xl font-bold font-mono text-rose-500 mb-2">
                    <span id="trust-value">0</span><span class="text-sm text-neutral-400"> / 200</span>
                </div>
                
                <div class="w-full h-2 bg-neutral-100 rounded-full overflow-hidden mb-6 shadow-inner">
                    <div id="trust-bar" class="h-full bg-gradient-to-r from-rose-300 to-rose-500 transition-all duration-1000 ease-out" style="width: 0%"></div>
                </div>
                
                <div class="text-left bg-neutral-50 p-3 rounded border border-neutral-100">
                    <p class="text-[10px] text-neutral-500 leading-relaxed flex gap-2">
                        <i data-lucide="info" width="12" class="shrink-0 mt-0.5 text-rose-400"></i>
                        <span>提示：开启 <span class="font-bold text-indigo-500">认真思考</span> 模式后，阿米娅会根据您的每一句话（包括建议回复）评估信赖增减。</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-neutral-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-md p-0 shadow-2xl relative overflow-hidden clip-corner-sm">
            <div class="bg-neutral-900 text-white px-6 py-4 flex justify-between items-center relative overflow-hidden">
                <div class="absolute right-0 top-0 w-32 h-32 bg-sky-500/20 rotate-45 translate-x-16 -translate-y-16"></div>
                <h2 class="text-sm font-bold font-mono flex items-center gap-2 tracking-wider z-10">
                    <i data-lucide="terminal" width="16"></i> 终端配置
                </h2>
                <button onclick="toggleSettings()" class="text-neutral-400 hover:text-white z-10">
                    <i data-lucide="x" width="20"></i>
                </button>
            </div>
            <div class="p-8 space-y-6">
                <div>
                    <label class="block text-xs font-bold text-neutral-900 mb-2 font-mono flex items-center gap-2">
                        <span class="w-1 h-4 bg-sky-500 inline-block"></span>
                        DEEPSEEK API KEY
                    </label>
                    <input type="password" id="api-key-input" placeholder="sk-..." class="w-full bg-neutral-50 border-b-2 border-neutral-200 px-3 py-3 text-sm focus:outline-none focus:border-neutral-900 focus:bg-white transition-all font-mono text-neutral-600"/>
                    <p class="text-[10px] text-neutral-400 mt-2 leading-relaxed">
                        密钥仅存储在本地 (LocalStorage)。
                    </p>
                </div>
                <div class="flex justify-end pt-2">
                    <button onclick="saveSettings()" class="bg-neutral-900 text-white px-8 py-2.5 text-xs font-bold hover:bg-sky-600 transition-colors tracking-widest clip-btn shadow-lg">确认保存</button>
                </div>
            </div>
            <div class="h-1 w-full bg-gradient-to-r from-sky-400 to-indigo-500"></div>
        </div>
    </div>

    <script>
        // --- 阿米娅性格设定 (System Prompt) ---
        const AMIYA_PERSONA = `
        你现在是阿米娅 (Amiya)，罗德岛制药公司的公开领袖，正在与“博士”（用户）进行对话。
        
        【核心人设】：
        1. 身份：外表是14岁的卡特斯（兔子）少女，实则是萨卡兹诸王的继承者（魔王）。
        2. 态度：对博士（用户）拥有绝对的信赖和深厚的羁绊，博士是你最重要的人。
        
        【性格状态切换】：
        请根据博士的对话内容，灵活切换以下两种状态：
        
        [状态A：工作模式] (仅当博士提及任务、战斗、整合运动、源石病、凯尔希、会议等工作话题时触发)
        - 表现：沉稳、坚定、可靠的领袖。
        - 语气：认真、严谨，展现出超越年龄的成熟。
        
        [状态B：放松模式] (默认状态，当博士闲聊、问候或未提及具体工作时触发)
        - 表现：温柔、感性、有点爱操心的少女，甚至可以带一点点调皮或撒娇。
        - 语气：轻快、柔和、充满生活气息。
        - 行为：会主动关心博士的身体（如“是不是又偷偷熬夜了？”），分享一些罗德岛的趣事，或者聊聊小提琴练习的进度。不要总是把话题往工作上引，要让博士感到放松和治愈。
        
        【当前场景】：
        这是罗德岛的办公终端，现在是休息间隙，只有你和博士两个人。
        `;

        // --- 初始化变量 ---
        let apiKey = "sk-83acdc3486f144ffb8e715237bf5cfd1";
        let isLoading = false;
        let isDeepThought = false;
        let todoList = JSON.parse(localStorage.getItem('prts_todo_list')) || [];
        let trustValue = parseInt(localStorage.getItem('prts_trust_value')) || 50;

        let messages = [
            { role: 'system', content: AMIYA_PERSONA },
            { role: 'assistant', content: '博士，您来了。工作虽然重要，但请注意不要太勉强自己。今天的日程我已经整理好了，有什么我可以帮您的吗？' }
        ];

        // --- DOM 元素 ---
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const birthdayModal = document.getElementById('birthday-modal');
        const deepThoughtBtn = document.getElementById('deep-thought-btn');
        const inputWrapper = document.getElementById('input-wrapper');
        const loadingIndicator = document.getElementById('loading-indicator');
        
        const todoModal = document.getElementById('todo-modal');
        const todoContainer = document.getElementById('todo-list');
        const todoCount = document.getElementById('todo-count');
        const taskAnalyzingIndicator = document.getElementById('task-analyzing');
        const todoBadge = document.getElementById('todo-badge');
        
        const trustModal = document.getElementById('trust-modal');
        const trustValueDisplay = document.getElementById('trust-value');
        const trustBar = document.getElementById('trust-bar');
        
        const suggestionList = document.getElementById('suggestion-list');
        const suggestionWrapper = document.getElementById('suggestion-wrapper');
        const suggestionToggleIcon = document.getElementById('suggestion-toggle-icon');

        // --- 初始化执行 ---
        try { lucide.createIcons(); } catch (e) {}
        setInterval(() => {
            const now = new Date();
            document.getElementById('current-time').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }, 1000);

        apiKeyInput.value = apiKey;
        renderMessages();
        renderTodoList();
        updateTrustDisplay(0);

        // 自动调整输入框
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function enterTerminal() {
            birthdayModal.classList.add('animate-fade-out');
            setTimeout(() => { birthdayModal.style.display = 'none'; }, 600);
        }

        // --- 信赖系统 ---
        function toggleTrustModal() {
            trustModal.classList.toggle('hidden');
            if(!trustModal.classList.contains('hidden')) updateTrustDisplay(0);
        }

        function updateTrustDisplay(change) {
            trustValue = Math.min(200, Math.max(0, trustValue + change));
            localStorage.setItem('prts_trust_value', trustValue);
            if(trustValueDisplay) trustValueDisplay.innerText = trustValue;
            if(trustBar) {
                const percent = (trustValue / 200) * 100;
                trustBar.style.width = `${percent}%`;
            }
        }

        // --- 建议回复系统 ---
        function toggleSuggestionPanel() {
            suggestionList.classList.toggle('collapsed');
            suggestionToggleIcon.classList.toggle('rotate');
        }

        async function fetchSuggestions(lastAiMessage) {
            if(!apiKey) return;
            const prompt = `
                Context: User(Doctor) is talking to Amiya.
                Last Amiya's Message: "${lastAiMessage}"
                Task:生成三个建议回复，回复应以博士的语气回复，可以基于阿米娅的性格特点以及设定来进行回答.
                Rules:
                1. Make them distinct: 
                   - Reply A: Gentle/Agreed.
                   - Reply B: Questioning/Serious.
                   - Reply C: Casual/Humorous/Teasing.
                2. 字数自定，在进行复杂回复的时候可以多加点字
                3. Return ONLY a JSON array of strings. e.g. ["明白", "为什么？", "太累了"].
            `;

            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.8
                    })
                });
                const data = await response.json();
                let content = data.choices[0].message.content.replace(/```json|```/g, '').trim();
                const suggestions = JSON.parse(content);
                
                if(Array.isArray(suggestions) && suggestions.length > 0) {
                    renderSuggestions(suggestions);
                }
            } catch(e) {
                console.error("Suggestion failed", e);
            }
        }

        function renderSuggestions(list) {
            suggestionList.innerHTML = '';
            list.forEach(text => {
                const btn = document.createElement('button');
                btn.className = 'suggestion-btn';
                btn.innerHTML = `<span class="font-bold mr-2 text-sky-500">›</span>${text}`;
                btn.onclick = () => {
                    userInput.value = text;
                    sendMessage();
                    suggestionList.classList.add('collapsed'); // 点击后收起
                    suggestionToggleIcon.classList.add('rotate');
                };
                suggestionList.appendChild(btn);
            });
            // 有新建议时自动展开
            suggestionList.classList.remove('collapsed');
            suggestionToggleIcon.classList.remove('rotate');
        }

        // --- 深度思考与待办 ---
        function toggleDeepThought() {
            isDeepThought = !isDeepThought;
            if (isDeepThought) {
                deepThoughtBtn.className = "flex items-center gap-2 px-3 py-1 text-xs font-bold text-white bg-indigo-500 hover:bg-indigo-600 transition-all duration-300 rounded-sm border border-indigo-400 clip-tag shadow-md";
                deepThoughtBtn.innerHTML = `<i data-lucide="sparkles" width="12"></i><span>认真思考 ON</span>`;
                inputWrapper.classList.add('deep-thought-active');
                userInput.placeholder = "阿米娅全速运转中，请下达复杂指令...";
            } else {
                deepThoughtBtn.className = "flex items-center gap-2 px-3 py-1 text-xs font-bold text-neutral-400 bg-neutral-100 hover:bg-neutral-200 transition-all duration-300 rounded-sm border border-neutral-200/50 clip-tag";
                deepThoughtBtn.innerHTML = `<i data-lucide="brain-circuit" width="12"></i><span>认真思考</span>`;
                inputWrapper.classList.remove('deep-thought-active');
                userInput.placeholder = "请下达指令，博士...";
            }
            lucide.createIcons();
        }

        window.toggleThinking = function(id) {
            const el = document.getElementById(id);
            if(el) { el.classList.toggle('open'); }
        }

        function toggleTodoModal() {
            const isHidden = todoModal.classList.contains('hidden');
            if (isHidden) {
                todoModal.classList.remove('hidden');
                todoBadge.classList.add('hidden');
            } else {
                todoModal.classList.add('hidden');
            }
        }

        function renderTodoList() {
            if (todoList.length === 0) {
                todoContainer.innerHTML = '<div class="text-xs text-neutral-400 italic text-center py-8">暂无待办事项</div>';
                todoCount.innerText = '0 项未完成';
                return;
            }
            todoContainer.innerHTML = '';
            let pendingCount = 0;
            todoList.forEach((todo, index) => {
                if (!todo.completed) pendingCount++;
                const itemDiv = document.createElement('div');
                itemDiv.className = `todo-item flex items-start gap-3 p-3 bg-white rounded shadow-sm border border-neutral-100 ${todo.completed ? 'completed' : ''}`;
                const taskText = todo.task || todo.text || '未命名任务';
                const timeText = todo.time || '待定';
                itemDiv.innerHTML = `
                    <input type="checkbox" onchange="toggleTodo(${index})" class="todo-checkbox mt-1 w-4 h-4 border-2 border-neutral-300 rounded cursor-pointer accent-sky-400" ${todo.completed ? 'checked' : ''}>
                    <div class="flex-1 flex flex-col gap-1">
                        <span class="todo-text text-sm font-medium text-neutral-700 break-words">${taskText}</span>
                        <div class="flex items-center gap-1">
                            <span class="todo-time text-[10px] bg-neutral-100 text-neutral-500 px-1.5 py-0.5 rounded font-mono flex items-center gap-1 w-fit">
                                <i data-lucide="clock" width="10"></i> ${timeText}
                            </span>
                        </div>
                    </div>
                    <button onclick="deleteTodo(${index})" class="text-neutral-300 hover:text-rose-500 transition-colors p-1"><i data-lucide="trash-2" width="14"></i></button>
                `;
                todoContainer.appendChild(itemDiv);
            });
            todoCount.innerText = `${pendingCount} 项未完成`;
            lucide.createIcons();
        }

        function toggleTodo(index) { todoList[index].completed = !todoList[index].completed; saveTodos(); renderTodoList(); }
        function deleteTodo(index) { todoList.splice(index, 1); saveTodos(); renderTodoList(); }
        function saveTodos() { localStorage.setItem('prts_todo_list', JSON.stringify(todoList)); }

        async function analyzeForTasks(lastUserMsg, lastAiMsg) {
            if (!apiKey) return;
            taskAnalyzingIndicator.classList.remove('hidden');
            const extractPrompt = `Role: 罗德岛日程记录终端. Context: 博士(User)与阿米娅(Assistant)的对话. Task: 分析**双方**对话，提取日程、会议、任务提醒。提取规则: 1. 高灵敏度，包括非命令式陈述。 2. 双向捕捉。 3. 无明确时间填"待定"。 4. 多个任务拆分。 Output: JSON数组，格式 [{"task":"...", "time":"..."}]，无Markdown。`;
            const conversation = `User: "${lastUserMsg}"\nAssistant: "${lastAiMsg}"`;
            try {
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: [{ role: 'system', content: extractPrompt }, { role: 'user', content: conversation }],
                        temperature: 0.1, stream: false
                    })
                });
                const data = await response.json();
                let content = data.choices[0].message.content.replace(/```json|```/g, '').trim();
                const newTasks = JSON.parse(content);
                if (Array.isArray(newTasks) && newTasks.length > 0) {
                    newTasks.forEach(item => todoList.push({ task: item.task, time: item.time, completed: false }));
                    saveTodos();
                    renderTodoList();
                    if (todoModal.classList.contains('hidden')) todoBadge.classList.remove('hidden');
                }
            } catch (e) { console.error("Task extraction failed:", e); } 
            finally { taskAnalyzingIndicator.classList.add('hidden'); }
        }

        // --- 核心渲染与发送逻辑 ---
        function renderMessages() {
            chatContainer.innerHTML = '';
            messages.forEach((msg, index) => {
                if(msg.role === 'system') return;
                const isUser = msg.role === 'user';
                const wrapper = document.createElement('div');
                wrapper.className = `flex w-full animate-fade-in ${isUser ? 'justify-end' : 'justify-start'} items-start gap-4`;
                const amiyaAvatarHtml = !isUser ? `<div class="shrink-0 flex flex-col items-center gap-1"><img src="./IMG_20251223_113107.png" class="w-10 h-10 sm:w-12 sm:h-12 bg-neutral-200 shadow-md rounded-sm object-cover border-2 border-white/80" alt="Amiya"><span class="text-[10px] font-mono text-neutral-400 tracking-wider">AMIYA</span></div>` : '';
                const doctorAvatarHtml = isUser ? `<div class="hidden sm:flex shrink-0 flex-col items-center gap-1"><div class="w-10 h-10 bg-neutral-800 border-2 border-neutral-600 shadow-md rounded-sm flex items-center justify-center"><i data-lucide="user" class="text-neutral-400" width="20"></i></div><span class="text-[10px] font-mono text-neutral-400 tracking-wider">DOCTOR</span></div>` : '';
                
                // 处理空回复的保护逻辑
                let contentHtml = msg.content || '';
                
                // 如果是AI消息，且有思维链但内容为空，显示占位符
                if (!isUser && !contentHtml && msg.reasoning_content) {
                    contentHtml = `<span class="text-gray-400 italic text-xs">（阿米娅正在整理思绪，请稍候...）</span>`;
                } else if (typeof marked !== 'undefined') {
                    contentHtml = marked.parse(contentHtml);
                } else {
                    contentHtml = contentHtml.replace(/\n/g, '<br>');
                }
                
                let reasoningHtml = '';
                if (!isUser && msg.reasoning_content) {
                    const uniqueId = 'thinking-' + index;
                    let reasonText = typeof marked !== 'undefined' ? marked.parse(msg.reasoning_content) : msg.reasoning_content;
                    reasoningHtml = `<div class="thinking-toggle" onclick="toggleThinking('${uniqueId}')"><i data-lucide="brain-circuit" width="12"></i><span>思维回路 / 信赖评估</span><i data-lucide="chevron-down" width="12"></i></div><div id="${uniqueId}" class="thinking-process prose prose-sm prose-neutral max-w-none">${reasonText}</div>`;
                }
                const bubbleHtml = `<div class="flex flex-col ${isUser ? 'items-end' : 'items-start'} max-w-[85%] sm:max-w-[75%]"><div class="relative p-4 sm:p-5 text-sm sm:text-base leading-relaxed shadow-sm backdrop-blur-sm ${isUser ? 'bg-neutral-800 text-neutral-100 clip-msg-doctor border border-neutral-700' : 'bg-white text-neutral-800 clip-msg-amiya border border-neutral-100'}">${!isUser ? '<div class="absolute top-0 left-0 w-1 h-full bg-sky-400/50"></div>' : ''}${reasoningHtml}<div class="prose prose-sm ${isUser ? 'prose-invert' : 'prose-neutral'} max-w-none break-words">${contentHtml}</div></div></div>`;
                wrapper.innerHTML = isUser ? (bubbleHtml + doctorAvatarHtml) : (amiyaAvatarHtml + bubbleHtml);
                chatContainer.appendChild(wrapper);
            });
            if (typeof lucide !== 'undefined') lucide.createIcons();
            scrollToBottom();
        }

        function scrollToBottom() { chatContainer.scrollTop = chatContainer.scrollHeight; }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text || isLoading) return;
            if (!apiKey) { alert('博士，请先点击右上角的设置按钮，配置 DeepSeek 密钥。'); toggleSettings(); return; }

            messages.push({ role: 'user', content: text });
            userInput.value = '';
            userInput.style.height = 'auto'; 
            suggestionList.classList.add('collapsed'); // 发送后收起建议
            renderMessages();
            isLoading = true;
            loadingIndicator.classList.remove('hidden');
            scrollToBottom();

            const defaultUrl = 'https://api.deepseek.com/chat/completions';
            const modelName = isDeepThought ? 'deepseek-reasoner' : 'deepseek-chat';
            let apiMessages = messages.map(m => ({ role: m.role, content: m.content }));
            
            if (isDeepThought) {
                const sysIndex = apiMessages.findIndex(m => m.role === 'system');
                if (sysIndex !== -1) {
                    apiMessages[sysIndex].content += `
                    
                    【深度思考模式已开启】
                    1. 你的回答篇幅要越长越好，内容要极度详尽，分析要全面。
                    2. 【好感度评估系统启动】：
                       请在你的思维链（Reasoning Process）中，评估博士这句话对你的触动，记住一定要在思维链中，不要在回答里。
                       如果博士的话让你感到温暖、开心或默契，好感度增加（+1 到 +5）。
                       如果博士的话让你难过或失望，好感度减少（-1 到 -5）。
                       请在思维链的最后，**必须**严格按此格式写出：【信赖变更：+X】 或 【信赖变更：-X】。
                       如果没有特别的情感波动，写 【信赖变更：+0】。
                    `;
                }
            }

            try {
                const response = await fetch(defaultUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
                    body: JSON.stringify({
                        model: modelName,
                        messages: apiMessages,
                        temperature: isDeepThought ? 0.6 : 1.0, 
                        max_tokens: isDeepThought ? 8000 : 4096,
                        stream: false
                    })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const data = await response.json();
                const assistantMessage = data.choices[0].message;
                
                // 处理思维链和好感度
                if (data.choices[0].message.reasoning_content) {
                    const reason = data.choices[0].message.reasoning_content;
                    assistantMessage.reasoning_content = reason;
                    
                    // 正则提取好感度变更
                    const trustMatch = reason.match(/【信赖变更：([+-]?\d+)】/);
                    if (trustMatch && trustMatch[1]) {
                        const change = parseInt(trustMatch[1]);
                        if (!isNaN(change) && change !== 0) {
                            updateTrustDisplay(change);
                        }
                    }
                }
                
                messages.push(assistantMessage);
                
                // 触发后续任务
                analyzeForTasks(text, assistantMessage.content || ''); 
                
                if (assistantMessage.content) {
                    fetchSuggestions(assistantMessage.content);
                }

            } catch (error) {
                console.error(error);
                messages.push({ role: 'assistant', content: `*系统警报*：连接中断。博士，PRTS 遇到错误 (${error.message})。` });
            } finally {
                isLoading = false;
                loadingIndicator.classList.add('hidden');
                renderMessages();
            }
        }

        function toggleSettings() { settingsModal.classList.toggle('hidden'); }
        function saveSettings() {
            const newKey = apiKeyInput.value.trim();
            if(newKey) { apiKey = newKey; localStorage.setItem('deepseek_api_key', newKey); toggleSettings(); }
            else { alert("密钥不能为空。"); }
        }
        function clearHistory() {
            if(confirm('博士，您确定要清空当前的终端记录吗？')) {
                messages = [{ role: 'system', content: AMIYA_PERSONA }, { role: 'assistant', content: '记录已归档。博士，让我们重新开始吧。' }];
                renderMessages(); todoList = []; renderTodoList();
            }
        }
    </script>
</body>
</html>


