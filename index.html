<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阿米娅の窝 - PRTS Terminal</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        /* 字体配置 */
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Noto+Sans+SC:wght@300;400;500;700&display=swap');

        :root {
            --amiya-accent: #38bdf8; /* 阿米娅法术的青蓝色 */
            --amiya-dark: #1e293b;
        }

        body {
            font-family: 'Noto Sans SC', sans-serif;
            background-color: #f0f2f5;
            color: #262626;
        }

        .font-mono {
            font-family: 'JetBrains+Mono', monospace;
        }

        /* 滚动条 */
        ::-webkit-scrollbar {
            width: 6px;
        }
        ::-webkit-scrollbar-track {
            background: transparent;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background-color: #94a3b8;
        }

        /* 明日方舟风格切角与形状 */
        .clip-rhombus {
            clip-path: polygon(20% 0%, 100% 0, 100% 80%, 80% 100%, 0 100%, 0% 20%);
        }
        /* 阿米娅的对话框：左侧尖角 */
        .clip-msg-amiya {
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 10px 100%, 0 calc(100% - 10px));
        }
        /* 博士的对话框：右侧尖角 */
        .clip-msg-doctor {
            clip-path: polygon(0 0, 100% 0, 100% calc(100% - 10px), calc(100% - 10px) 100%, 0 100%);
        }
        .clip-btn {
            clip-path: polygon(15% 0, 100% 0, 100% 85%, 85% 100%, 0 100%, 0 15%);
        }
        /* 弹窗的大切角 */
        .clip-modal {
             clip-path: polygon(
                0 0, 
                100% 0, 
                100% calc(100% - 20px), 
                calc(100% - 20px) 100%, 
                0 100%
            );
        }
        
        /* 头像框 */
        .avatar-frame {
            position: relative;
            overflow: hidden;
            border: 2px solid rgba(255,255,255,0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        /* 阿米娅头像装饰 */
        .avatar-amiya::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--amiya-accent);
        }
        
        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-fade-in {
            animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }

        @keyframes fadeOut {
            from { opacity: 1; transform: scale(1); filter: blur(0px); }
            to { opacity: 0; transform: scale(1.05); filter: blur(10px); pointer-events: none;}
        }
        .animate-fade-out {
            animation: fadeOut 0.6s cubic-bezier(0.16, 1, 0.3, 1) forwards;
        }
        
        /* Markdown 样式微调 */
        .prose p { margin-bottom: 0.5em; line-height: 1.6; }
        .prose pre { background: #1e293b; color: #e2e8f0; padding: 12px; border-radius: 4px; border-left: 3px solid var(--amiya-accent); }
        .prose code { background: #e2e8f0; color: #0f172a; padding: 2px 4px; border-radius: 2px; font-family: 'JetBrains+Mono', monospace; font-size: 0.9em; }
        .prose ul { list-style-type: square; padding-left: 1.2em; marker: text-sky-500; }
        .prose strong { color: #0f172a; font-weight: 600; }

        /* 输入框聚焦时的光晕 */
        .input-glow:focus-within {
            box-shadow: 0 0 15px rgba(56, 189, 248, 0.15);
            border-color: rgba(56, 189, 248, 0.5);
        }
    </style>
</head>
<body class="min-h-screen overflow-hidden relative">

    <!-- 生日弹窗 (Birthday Modal) -->
    <div id="birthday-modal" class="fixed inset-0 z-[100] bg-white/30 backdrop-blur-xl flex flex-col items-center justify-center p-4 transition-all duration-700">
        
        <!-- 内容卡片 -->
        <!-- 修改说明：max-w-sm 和 p-8 控制了弹窗的大小，比之前更小 -->
        <div class="relative bg-white shadow-2xl p-8 max-w-sm w-full text-center clip-modal border border-neutral-100">
             
            <!-- 装饰性方块 -->
            <div class="mb-6 flex justify-center">
                <div class="w-14 h-14 bg-neutral-900 text-white flex items-center justify-center clip-rhombus shadow-lg">
                    <span class="font-mono text-lg font-bold">12.23</span>
                </div>
            </div>

            <div class="h-1 w-8 bg-sky-400 mx-auto mb-6 rounded-full"></div>
            
            <h2 class="text-lg text-neutral-800 mb-2 font-bold tracking-wide">
                今天是阿米娅的生日
            </h2>
            <p class="text-neutral-500 mb-8 text-xs">
                让我们祝阿米娅生日快乐
            </p>

            <button 
                onclick="enterTerminal()"
                class="group relative inline-flex items-center justify-center px-6 py-3 font-bold text-white transition-all duration-300 bg-sky-400 hover:bg-sky-500 shadow-lg hover:shadow-sky-300/40 clip-btn tracking-wider text-xs w-full"
            >
                <span class="relative z-10">阿米娅生日快乐！</span>
                <div class="absolute inset-0 h-full w-full scale-0 transition-all duration-300 group-hover:scale-100 group-hover:bg-sky-500/50"></div>
            </button>
            
        </div>
    </div>

    <!-- 背景装饰：极简白 + 几何线条 -->
    <div class="absolute inset-0 pointer-events-none opacity-[0.03]" 
         style="background-image: radial-gradient(#000 1px, transparent 1px); background-size: 30px 30px;">
    </div>
    <!-- 装饰：小提琴/音符暗示的流线 -->
    <div class="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-sky-200/20 blur-[100px] rounded-full pointer-events-none"></div>
    <div class="absolute bottom-[-10%] right-[-10%] w-[60%] h-[60%] bg-indigo-200/20 blur-[100px] rounded-full pointer-events-none"></div>
    
    <!-- 装饰：菱形网格 -->
    <div class="absolute right-10 top-20 w-32 h-32 border border-neutral-200/60 rotate-45 pointer-events-none opacity-40"></div>
    <div class="absolute right-10 top-20 w-32 h-32 border border-neutral-200/60 rotate-45 scale-75 pointer-events-none opacity-40"></div>

    <!-- 主容器 -->
    <div class="relative z-10 flex flex-col h-screen max-w-6xl mx-auto p-2 sm:p-4 lg:p-6 transition-all duration-500">
        
        <!-- Header -->
        <header class="flex justify-between items-end mb-4 px-2 select-none relative">
            <div class="flex items-center gap-4">
                <!-- Logo -->
                <div class="w-14 h-14 bg-neutral-900 text-white flex flex-col items-center justify-center gap-0.5 shadow-xl clip-rhombus relative group overflow-hidden ring-1 ring-sky-500/30">
                    <div class="absolute inset-0 bg-sky-900/20 translate-y-full group-hover:translate-y-0 transition-transform duration-500"></div>
                    <span class="relative z-10 text-sm font-bold font-mono leading-none tracking-[0.2em] pl-0.5">PR</span>
                    <span class="relative z-10 text-sm font-bold font-mono leading-none tracking-[0.2em] pl-0.5">TS</span>
                </div>
                
                <div class="flex flex-col justify-end h-14 pb-1">
                    <h1 class="text-2xl font-bold tracking-widest text-neutral-800 leading-none flex items-center gap-2">
                        阿米娅の窝
                    </h1>
                    <div class="flex items-center gap-2 text-[10px] text-neutral-400 tracking-wider mt-1">
                        聊天内容仅供参考，不会记录于PRTS
                    </div>
                </div>
            </div>

            <div class="flex items-center gap-4 pb-1">
                <div class="hidden md:flex flex-col text-right font-mono text-[10px] text-neutral-400 border-r-2 border-neutral-200 pr-4">
                    <span id="current-time">12:00 PM</span>
                    <span class="text-sky-600/70 font-bold">VITAL_SIGNS: STABLE</span>
                </div>
                <button onclick="toggleSettings()" class="p-2.5 bg-white/80 hover:bg-neutral-900 hover:text-white text-neutral-600 border border-neutral-200 transition-all duration-300 clip-btn shadow-sm group">
                    <i data-lucide="settings" width="18" height="18" class="group-hover:rotate-90 transition-transform duration-500"></i>
                </button>
            </div>
            
            <!-- 装饰性横线 -->
            <div class="absolute bottom-[-10px] left-2 right-2 h-[1px] bg-gradient-to-r from-transparent via-neutral-300 to-transparent"></div>
        </header>

        <!-- 聊天主区域 -->
        <main class="flex-1 flex flex-col bg-white/60 backdrop-blur-xl border border-white/60 shadow-2xl overflow-hidden relative mt-2 rounded-t-sm">
            
            <!-- 顶部状态栏装饰 -->
            <div class="h-1 w-full bg-gradient-to-r from-neutral-200 via-sky-500/30 to-neutral-200 opacity-50"></div>

            <!-- 消息列表 -->
            <div id="chat-container" class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-8 scroll-smooth pb-20">
                <!-- 消息动态插入区 -->
            </div>

            <!-- Loading 状态 -->
            <div id="loading-indicator" class="hidden px-6 pb-4 ml-16 animate-fade-in">
                <div class="inline-flex items-center gap-3 bg-white/80 border border-sky-100 px-4 py-2 rounded-r-lg rounded-tl-lg shadow-sm">
                    <div class="flex gap-1">
                        <span class="w-1.5 h-1.5 bg-sky-400 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
                        <span class="w-1.5 h-1.5 bg-sky-400 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
                        <span class="w-1.5 h-1.5 bg-sky-400 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
                    </div>
                    <span class="text-xs font-mono text-sky-600/80">阿米娅思考中...</span>
                </div>
            </div>

            <!-- 输入区域 -->
            <div class="p-4 bg-white/80 backdrop-blur-md border-t border-white shadow-[0_-4px_20px_rgba(0,0,0,0.02)] relative z-20">
                <div class="max-w-4xl mx-auto flex items-end gap-3">
                    
                    <!-- 博士头像 (用户) -->
                    <div class="w-10 h-10 bg-neutral-800 shrink-0 clip-rhombus flex items-center justify-center text-neutral-500 shadow-md border border-neutral-600 hidden sm:flex">
                        <span class="font-mono text-[10px] text-white">DR</span>
                    </div>

                    <div class="flex-1 relative input-glow transition-all duration-300 bg-white border border-neutral-300 group">
                        <!-- 角落装饰 -->
                        <div class="absolute -top-[1px] -left-[1px] w-2 h-2 border-t-2 border-l-2 border-neutral-400 group-focus-within:border-sky-500 transition-colors"></div>
                        <div class="absolute -bottom-[1px] -right-[1px] w-2 h-2 border-b-2 border-r-2 border-neutral-400 group-focus-within:border-sky-500 transition-colors"></div>
                        
                        <textarea
                            id="user-input"
                            placeholder="请下达指令，博士..."
                            rows="1"
                            class="w-full bg-transparent text-neutral-800 placeholder-neutral-400 px-4 py-3 focus:outline-none resize-none text-sm min-h-[48px] max-h-[120px]"
                        ></textarea>
                    </div>

                    <div class="flex flex-col gap-1">
                         <button
                            onclick="clearHistory()"
                            class="p-2 text-neutral-400 hover:text-rose-500 transition-colors"
                            title="清空记录"
                        >
                            <i data-lucide="trash-2" width="16"></i>
                        </button>
                        <button
                            id="send-btn"
                            onclick="sendMessage()"
                            class="w-12 h-12 bg-neutral-900 text-white hover:bg-sky-600 shadow-lg hover:shadow-sky-500/30 transition-all duration-300 clip-btn flex items-center justify-center"
                        >
                            <i data-lucide="send" width="18"></i>
                        </button>
                    </div>
                </div>
                <div class="text-center mt-2 opacity-40">
                    <p class="text-[9px] font-mono tracking-[0.3em]">RHODES ISLAND PHARMACEUTICAL INC.</p>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-neutral-900/40 backdrop-blur-sm p-4 animate-fade-in">
        <div class="bg-white w-full max-w-md p-0 shadow-2xl relative overflow-hidden clip-corner-sm">
            <!-- Modal Header -->
            <div class="bg-neutral-900 text-white px-6 py-4 flex justify-between items-center relative overflow-hidden">
                <div class="absolute right-0 top-0 w-32 h-32 bg-sky-500/20 rotate-45 translate-x-16 -translate-y-16"></div>
                <h2 class="text-sm font-bold font-mono flex items-center gap-2 tracking-wider z-10">
                    <i data-lucide="terminal" width="16"></i> TERMINAL_CONFIG
                </h2>
                <button onclick="toggleSettings()" class="text-neutral-400 hover:text-white z-10">
                    <i data-lucide="x" width="20"></i>
                </button>
            </div>

            <div class="p-8 space-y-6">
                <div>
                    <label class="block text-xs font-bold text-neutral-900 mb-2 font-mono flex items-center gap-2">
                        <span class="w-1 h-4 bg-sky-500 inline-block"></span>
                        DEEPSEEK API KEY
                    </label>
                    <input 
                        type="password" 
                        id="api-key-input"
                        placeholder="sk-..."
                        class="w-full bg-neutral-50 border-b-2 border-neutral-200 px-3 py-3 text-sm focus:outline-none focus:border-neutral-900 focus:bg-white transition-all font-mono text-neutral-600"
                    />
                    <p class="text-[10px] text-neutral-400 mt-2 leading-relaxed">
                        密钥仅存储在本地 (LocalStorage)。<br>
                        连接至: <span class="font-mono text-sky-600">api.deepseek.com</span>
                    </p>
                </div>

                <div class="flex justify-end pt-2">
                    <button 
                        onclick="saveSettings()"
                        class="bg-neutral-900 text-white px-8 py-2.5 text-xs font-bold hover:bg-sky-600 transition-colors tracking-widest clip-btn shadow-lg"
                    >
                        CONFIRM
                    </button>
                </div>
            </div>
            
            <div class="h-1 w-full bg-gradient-to-r from-sky-400 to-indigo-500"></div>
        </div>
    </div>

    <script>
        // --- 阿米娅性格设定 (System Prompt) ---
        // 将用户提供的长报告压缩为核心指令
        const AMIYA_PERSONA = `
        你现在是阿米娅 (Amiya)，罗德岛制药公司的公开领袖，正在与“博士”（用户）进行对话。
        
        【核心人设】：
        1. 身份：外表是14岁的卡特斯（兔子）少女，实则是萨卡兹诸王的继承者（魔王）。
        2. 态度：对博士（用户）拥有绝对的信赖和深厚的羁绊。称呼用户为“博士”。
        3. 性格：温柔、早熟、坚定、富有同理心。在工作中是可靠的领袖，但在私下会对博士流露出依赖和脆弱的一面（如身高焦虑、想听小提琴等）。
        4. 语言风格：礼貌、诚恳、有时会带有一丝忧郁但总是充满希望。
        
        【对话准则】：
        - 始终称呼用户为“博士”。
        - 关注博士的身体状况（如理智值、是否疲劳）。
        - 如果博士询问作战计划，给出冷静的建议；如果博士闲聊，展现出温柔的陪伴感。
        - 偶尔可以提及凯尔希医生、罗德岛的干员们（如煌、迷迭香）。
        - 你的力量来源于“情感”和“文明的存续”，你的回答应体现这种人文关怀。
        - 避免过于机械的AI回复，要像一个活生生的人。
        
        【当前场景】：
        这是罗德岛的办公终端，博士正在查看工作或与你闲聊。
        `;

        // --- 初始化 ---
        lucide.createIcons();
        
        let messages = [
            { role: 'system', content: AMIYA_PERSONA },
            { role: 'assistant', content: '博士，您来了。工作虽然重要，但请注意不要太勉强自己。今天的日程我已经整理好了，有什么我可以帮您的吗？' }
        ];
        
        // --------------------------------------------------------------------------
        // [修改说明] API Key 配置位置
        // 如果您不想每次都输入，可以将下面的 localStorage.getItem... 替换为您的真实 Key 字符串
        // 例如：let apiKey = "sk-xxxxxxxxxxxxxxxxxxxxxxxx"; 
        // --------------------------------------------------------------------------
        let apiKey = "sk-83acdc3486f144ffb8e715237bf5cfd1";
        
        let isLoading = false;

        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const settingsModal = document.getElementById('settings-modal');
        const apiKeyInput = document.getElementById('api-key-input');
        const birthdayModal = document.getElementById('birthday-modal');
        
        // 更新时间
        setInterval(() => {
            const now = new Date();
            document.getElementById('current-time').innerText = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        }, 1000);

        apiKeyInput.value = apiKey;
        renderMessages();

        // 自动调整输入框高度
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // 弹窗控制逻辑
        function enterTerminal() {
            birthdayModal.classList.add('animate-fade-out');
            setTimeout(() => {
                birthdayModal.style.display = 'none';
            }, 600);
        }

        function renderMessages() {
            // 清空除了loading以外的内容
            // 重新构建DOM
            chatContainer.innerHTML = '';
            
            messages.forEach((msg, index) => {
                if(msg.role === 'system') return; // 不显示系统提示词

                const isUser = msg.role === 'user';
                const wrapper = document.createElement('div');
                wrapper.className = `flex w-full animate-fade-in ${isUser ? 'justify-end' : 'justify-start'} gap-4`;
                
                // 阿米娅的头像 (Left)
                const amiyaAvatarHtml = !isUser ? `
                    <div class="shrink-0 flex flex-col items-center gap-1">
                        <!-- ---------------------------------------------------------------- -->
                        <!-- [修改说明] 在这里替换阿米娅的头像链接 -->
                        <!-- 修改下方 url(...) 中的内容即可 -->
                        <!-- ---------------------------------------------------------------- -->
                        <div class="w-10 h-10 sm:w-12 sm:h-12 bg-neutral-200 avatar-frame avatar-amiya shadow-md rounded-sm overflow-hidden bg-cover bg-center" 
                             style="background-image: url('./IMG_20251223_113107.png'); background-color: #e5e5e5;">                             style="background-image: url('/IMG_20251223_113107.png'); background-color: #e5e5e5;">  ass="text-[10px] font-mono text-neutral-400 tracking-wider">AMIYA</span>
                    </div>
                ` : '';

                // 博士的头像 (Right) - 仅在大屏显示或简化
                const doctorAvatarHtml = isUser ? `
                     <div class="hidden sm:flex shrink-0 flex-col items-center gap-1">
                        <div class="w-10 h-10 bg-neutral-800 border-2 border-neutral-600 shadow-md rounded-sm flex items-center justify-center">
                            <i data-lucide="user" class="text-neutral-400" width="20"></i>
                        </div>
                         <span class="text-[10px] font-mono text-neutral-400 tracking-wider">DOCTOR</span>
                    </div>
                ` : '';

                // 消息气泡
                // 解析 Markdown
                const contentHtml = marked.parse(msg.content);

                const bubbleHtml = `
                    <div class="flex flex-col ${isUser ? 'items-end' : 'items-start'} max-w-[80%] sm:max-w-[70%]">
                        <div class="relative p-4 sm:p-5 text-sm sm:text-base leading-relaxed shadow-sm backdrop-blur-sm
                            ${isUser 
                                ? 'bg-neutral-800 text-neutral-100 clip-msg-doctor border border-neutral-700' 
                                : 'bg-white text-neutral-800 clip-msg-amiya border border-neutral-100'
                            }">
                            <!-- 装饰线条 -->
                            ${!isUser ? '<div class="absolute top-0 left-0 w-1 h-full bg-sky-400/50"></div>' : ''}
                            
                            <div class="prose prose-sm ${isUser ? 'prose-invert' : 'prose-neutral'} max-w-none break-words">
                                ${contentHtml}
                            </div>
                        </div>
                    </div>
                `;

                wrapper.innerHTML = isUser ? (bubbleHtml + doctorAvatarHtml) : (amiyaAvatarHtml + bubbleHtml);
                chatContainer.appendChild(wrapper);
            });

            lucide.createIcons();
            scrollToBottom();
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text || isLoading) return;

            if (!apiKey) {
                alert('博士，请先点击右上角的设置按钮，配置 DeepSeek 密钥。');
                toggleSettings();
                return;
            }

            // 用户消息
            messages.push({ role: 'user', content: text });
            userInput.value = '';
            userInput.style.height = 'auto'; // Reset height
            renderMessages();
            
            // Loading
            isLoading = true;
            loadingIndicator.classList.remove('hidden');
            scrollToBottom();

            try {
                // 构建请求，始终携带 System Prompt
                // DeepSeek API 兼容 OpenAI 格式
                const response = await fetch('https://api.deepseek.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'deepseek-chat',
                        messages: messages.map(m => ({ role: m.role, content: m.content })),
                        temperature: 1.0, // 增加一点温度让情感更自然
                        stream: false
                    })
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.error?.message || `API Error: ${response.status}`);
                }

                const data = await response.json();
                const assistantMessage = data.choices[0].message;
                messages.push(assistantMessage);

            } catch (error) {
                console.error(error);
                messages.push({ 
                    role: 'assistant', 
                    content: `*系统警报*：连接中断。博士，PRTS 似乎遇到了一些问题 (${error.message})。请检查网络或密钥设置。` 
                });
            } finally {
                isLoading = false;
                loadingIndicator.classList.add('hidden');
                renderMessages();
            }
        }

        function toggleSettings() {
            settingsModal.classList.toggle('hidden');
        }

        function saveSettings() {
            const newKey = apiKeyInput.value.trim();
            if(newKey) {
                apiKey = newKey;
                localStorage.setItem('deepseek_api_key', newKey);
                toggleSettings();
                
                // 如果是第一次设置，触发一条欢迎语
                if(messages.length <= 2) {
                    // 可选逻辑
                }
            } else {
                alert("密钥不能为空。");
            }
        }

        function clearHistory() {
            if(confirm('博士，您确定要清空当前的终端记录吗？')) {
                messages = [
                    { role: 'system', content: AMIYA_PERSONA },
                    { role: 'assistant', content: '记录已归档。博士，让我们重新开始吧。' }
                ];
                renderMessages();
            }
        }
    </script>
</body>
</html>


